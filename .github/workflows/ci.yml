name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.python-version }}-
            ${{ runner.os }}-uv-

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras --python ${{ matrix.python-version }}

      - name: Run linting
        run: |
          uv run ruff check src tests
          uv run ruff format --check src tests

      - name: Run unit tests
        run: uv run pytest tests/test_rename.py -v

      - name: Run integration tests
        run: uv run pytest tests/test_integration.py -v

  integration-icechunk:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-3.12-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-3.12-
            ${{ runner.os }}-uv-

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install spare-tire
        run: uv sync --all-extras --python 3.12

      - name: Download icechunk wheel from nightly
        run: |
          mkdir -p wheels
          pip download icechunk \
            --index-url https://pypi.anaconda.org/scientific-python-nightly-wheels/simple \
            --no-deps \
            -d ./wheels/ || echo "Download failed, skipping integration test"

      - name: Inspect and rename wheel
        run: |
          if ls wheels/icechunk-*.whl 1> /dev/null 2>&1; then
            uv run spare-tire inspect wheels/icechunk-*.whl
            uv run spare-tire rename wheels/icechunk-*.whl icechunk_v1 -o ./wheels/
            ls -la wheels/
          else
            echo "No wheel found, skipping"
          fi

      - name: Install renamed wheel and verify imports
        run: |
          if ls wheels/icechunk_v1-*.whl 1> /dev/null 2>&1; then
            # Create a test venv
            uv venv test-venv --python 3.12
            uv pip install --python test-venv/bin/python wheels/icechunk_v1-*.whl

            # Verify the import works
            test-venv/bin/python -c "
          import icechunk_v1
          print(f'Successfully imported icechunk_v1 version: {icechunk_v1.__version__}')

          # Verify key classes are accessible
          from icechunk_v1 import Repository, IcechunkStore, Session
          print('All key classes imported successfully')
          "
          else
            echo "No renamed wheel found, skipping verification"
          fi

  proxy-dual-install:
    runs-on: ubuntu-latest
    needs: test
    name: Test proxy with dual icechunk install

    steps:
      - uses: actions/checkout@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-3.12-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-3.12-
            ${{ runner.os }}-uv-

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install spare-tire with server extras
        run: uv sync --all-extras --python 3.12

      - name: Start proxy server
        run: |
          # Start proxy in background with icechunk v1 (<2) renamed
          uv run spare-tire serve \
            -u https://pypi.anaconda.org/scientific-python-nightly-wheels/simple \
            -r "icechunk=icechunk_v1:<2" \
            --port 8123 &

          # Wait for server to start
          sleep 5

          # Verify server is running
          curl -s http://127.0.0.1:8123/simple/ | grep icechunk_v1

      - name: Run uv sync to install both versions
        run: |
          cd tests/fixtures/dual-install

          # Use uv sync to install both packages with all their dependencies
          uv sync --python 3.12

          # Show what was installed
          echo "Installed icechunk packages:"
          uv pip list | grep -i icechunk

      - name: Verify both versions are installed and isolated
        run: |
          cd tests/fixtures/dual-install
          uv run python -c "
          import sys

          # Import both versions
          import icechunk_v1
          import icechunk

          print(f'icechunk_v1 version: {icechunk_v1.__version__}')
          print(f'icechunk version: {icechunk.__version__}')

          # Verify they are different versions
          v1_version = icechunk_v1.__version__
          v2_version = icechunk.__version__

          print(f'v1 module path: {icechunk_v1.__file__}')
          print(f'v2 module path: {icechunk.__file__}')

          # v1 should be < 2.0, v2 should be >= 2.0
          assert 'icechunk_v1' in icechunk_v1.__file__, 'v1 module path should contain icechunk_v1'
          assert 'icechunk_v1' not in icechunk.__file__, 'v2 module path should not contain icechunk_v1'

          # Verify they are different modules (isolation check)
          assert icechunk_v1 is not icechunk, 'Modules should be different objects'

          print('SUCCESS: Both versions installed and isolated correctly!')
          "
